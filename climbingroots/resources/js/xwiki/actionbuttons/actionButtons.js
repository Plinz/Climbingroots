var XWiki=(function(e){var h=e.actionButtons=e.actionButtons||{};var c,f,d,a;var g=new Date();var b=function(j){if(c.equals(j.memo.documentReference)){if(!a&&f!=j.memo.version){window.location.reload()}f=j.memo.version;g=new Date();d="false";a=true}};document.observe("xwiki:document:changeVersion",b);h.EditActions=Class.create({initialize:function(){this.addListeners();this.addShortcuts();this.addValidators()},addListeners:function(){$$("input[name=action_cancel]").each(function(j){j.observe("click",this.onCancel.bindAsEventListener(this))}.bind(this));$$("input[name=action_preview]").each(function(j){j.observe("click",this.onSubmit.bindAsEventListener(this,"preview"))}.bind(this));$$("input[name=action_save]").each(function(j){j.observe("click",this.onSubmit.bindAsEventListener(this,"save"))}.bind(this));$$("input[name=action_saveandcontinue]").each(function(j){j.observe("click",this.onSubmit.bindAsEventListener(this,"save",true))}.bind(this))},addShortcuts:function(){var j={action_cancel:"$services.localization.render('core.shortcuts.edit.cancel')",action_preview:"$services.localization.render('core.shortcuts.edit.preview')",action_edit:"$services.localization.render('core.shortcuts.edit.backtoedit')",action_inline:"$services.localization.render('core.shortcuts.edit.backtoedit')",action_save:"$services.localization.render('core.shortcuts.edit.saveandview')",action_propupdate:"$services.localization.render('core.shortcuts.edit.saveandview')",action_saveandcontinue:"$services.localization.render('core.shortcuts.edit.saveandcontinue')"};for(var k in j){var l=$$("input[name="+k+"]");if(l.size()>0){shortcut.add(j[k],function(){this.click()}.bind(l.first()))}}},validators:new Array(),addValidators:function(){var j=$("body").select("input.required");for(var m=0;m<j.length;m++){var k=j[m];var l=new LiveValidation(k,{validMessage:""});l.add(Validate.Presence,{failureMessage:"$services.localization.render('core.validation.required.message')"});l.validate();this.validators.push(l)}},validateForm:function(l){for(var k=0;k<this.validators.length;k++){if(!this.validators[k].validate()){return false}}var m=l.comment;if(m&&($xwiki.isEditCommentSuggested()||$xwiki.isEditCommentMandatory())){while(m.value==""){var j=prompt("$services.localization.render('core.comment.prompt')","");if(j===null){return false}m.value=j;if(!$xwiki.isEditCommentMandatory()){break}}}return true},onCancel:function(l){l.stop();this.notify(l,"cancel");var k=l.element().form.action;if(typeof k!="string"){k=l.element().form.attributes.getNamedItem("action");if(k){k=k.nodeValue}else{k=window.self.location.href}}var n=k.split("#",2);var p=(n.length==2)?n[1]:"";k=n[0];if(k.indexOf("?")==-1){k+="?"}var o="&action_cancel=true";var m=l.element().form.select('input[name="xredirect"]')[0];var j=m?"&xredirect="+escape(m.value):"";e.EditLock&&e.EditLock.setLocked(false);window.location=k+o+j+p},onSubmit:function(l,m,k){var j="before"+m.substr(0,1).toUpperCase()+m.substr(1);if(this.notify(l,j,{"continue":k})){if(this.validateForm(l.element().form)){this.notify(l,m,{"continue":k})}else{l.stop()}}},notify:function(j,l,n){var k=document.fire("xwiki:actions:"+l,Object.extend({originalEvent:j,form:j.element().form},n||{}));var m=k.stopped||j.stopped;if(m){j.stop()}return !m}});h.AjaxSaveAndContinue=Class.create({initialize:function(){this.createMessages();this.addListeners()},createMessages:function(){this.savingBox=new e.widgets.Notification("$escapetool.javascript($services.localization.render('core.editors.saveandcontinue.notification.inprogress'))","inprogress",{inactive:true});this.savedBox=new e.widgets.Notification("$escapetool.javascript($services.localization.render('core.editors.saveandcontinue.notification.done'))","done",{inactive:true});this.failedBox=new e.widgets.Notification('$escapetool.javascript($services.localization.render("core.editors.saveandcontinue.notification.error", ["<span id=""ajaxRequestFailureReason""/>"]))',"error",{inactive:true});this.progressMessageTemplate="$escapetool.javascript($services.localization.render('core.editors.savewithprogress.notification'))";this.progressBox=new e.widgets.Notification(this.progressMessageTemplate.replace("__PROGRESS__","0"),"inprogress",{inactive:true})},addListeners:function(){document.observe("xwiki:actions:save",this.onSave.bindAsEventListener(this))},disableEditors:function(){if(this.form){this.form.disable()}},enableEditors:function(){if(this.form){this.form.enable()}},onSave:function(n){if(n.stopped){return}var q=n.memo["continue"];this.form=$(n.memo.form);this.savedBox.hide();this.failedBox.hide();var k=(this.form.template&&this.form.template.value);var m=(this.form.action.indexOf("/preview/")==-1&&this.form.action.indexOf("/save/")==-1);if(m&&!q){return}var j=window.location.href.indexOf("/edit/")!=-1;if(j){if($("previousVersion")){$("previousVersion").setValue(f);$("editingVersionDate").setValue(g.toISOString());$("isNew").setValue(d)}else{this.form.insert(new Element("input",{type:"hidden",name:"previousVersion",id:"previousVersion",value:f}));this.form.insert(new Element("input",{type:"hidden",name:"editingVersionDate",id:"editingVersionDate",value:g.toISOString()}));this.form.insert(new Element("input",{type:"hidden",name:"isNew",id:"isNew",value:d.toString()}))}}var o=(this.form.async&&this.form.async.value==="true");if(!o){k=false}n.stop();if(k){this.progressBox.show()}else{this.savingBox.show()}var l="action_save";if(q){l="action_saveandcontinue"}var p=new Hash(this.form.serialize({hash:true,submit:l}));if(q){p.set("minorEdit","1")}if(!Prototype.Browser.Opera){p.set("ajax","true")}if(!q){this.disableEditors()}new Ajax.Request(this.form.action,{method:"post",parameters:p.toQueryString(),onSuccess:this.onSuccess.bindAsEventListener(this,q,k),on1223:this.on1223.bindAsEventListener(this),on0:this.on0.bindAsEventListener(this),on409:this.on409.bindAsEventListener(this,q),on401:this.on401.bindAsEventListener(this),on403:this.on403.bindAsEventListener(this,q,k),onFailure:this.onFailure.bind(this)})},on1223:function(j){j.request.options.onSuccess(j)},on0:function(j){j.request.options.onFailure(j)},onSuccess:function(k,l,j){if(this.form&&this.form.template){this.form.template.disabled=true;this.form.template.value=""}if($("forceSave")){$("forceSave").remove()}if(j){if(k.responseJSON){this.getStatus(k.responseJSON.links[0].href,l)}else{this.progressBox.hide();this.savingBox.replace(this.savedBox)}}else{if(!j&&(!l||$("body").hasClassName("previewbody"))){document.fire("xwiki:document:saved");this.maybeRedirect(l)}else{this.progressBox.hide();this.savingBox.replace(this.savedBox)}}if(k.responseJSON&&k.responseJSON.newVersion){require(["xwiki-meta"],function(m){m.setVersion(k.responseJSON.newVersion)})}document.fire("xwiki:document:saved")},displayErrorModal:function(j){e.widgets.ErrorModalPopup=Class.create(e.widgets.ModalPopup,{defaultInteractionParameters:{},initialize:function($super,k){this.interactionParameters=Object.extend(Object.clone(this.defaultInteractionParameters),k||{});$super(j(this.interactionParameters,this),{show:{method:this.showDialog,keys:[]},},{displayCloseButton:false,verticalPosition:"center",backgroundColor:"#FFF",removeOnClose:true});this.showDialog()}});return new e.widgets.ErrorModalPopup()},on401:function(j){this.progressBox.hide();this.savingBox.hide();this.savedBox.hide();this.failedBox.hide();var k=function(r,q){var p=new Element("div",{"class":"modal-popup"});var m=new Element("div");p.insert("$services.localization.render('core.editors.save.authorizationError.message')");p.insert(new Element("br"));p.insert(new Element("br"));var s=e.currentDocument.getURL("login");var o=new Element("a",{title:"login",href:s,target:"_new"});o.insert("$services.localization.render('core.editors.save.authorizationError.followLink')");p.insert(o);p.insert(m);var n=new Element("br");var l=new Element("button",{"class":"btn btn-primary"});l.insert("OK");m.insert(n);m.insert(l);l.on("click",function(){q.closeDialog()});return p};this.displayErrorModal(k);this.enableEditors();document.fire("xwiki:document:saveFailed",{response:j})},on403:function(l,o,j){this.progressBox.hide();this.savingBox.hide();this.savedBox.hide();this.failedBox.hide();if(l.responseJSON&&l.responseJSON.errorType==="CSRF"){var m=l.responseJSON;var k=this;var n=function(u,s){var t=function(){$$("input[name=form_token]").each(function(v){v.value=m.newToken});new Ajax.Request(m.resubmissionURI,{method:"post",parameters:"form_token="+m.newToken,onSuccess:k.onSuccess.bindAsEventListener(k,o,j),on1223:k.on1223.bindAsEventListener(k),on0:k.on0.bindAsEventListener(k),on409:k.on409.bindAsEventListener(k,o),on401:k.on401.bindAsEventListener(k),on403:k.on403.bindAsEventListener(k,o,j),onFailure:k.onFailure.bind(k)});s.closeDialog()};var r=new Element("div",{"class":"modal-popup",id:"csrf-warning-modal"});var q=new Element("div");r.insert("$escapetool.json($services.localization.render('csrf.confirmation'))");r.insert(new Element("br"));var p=new Element("button",{"class":"btn btn-default",id:"force-save-csrf"});p.insert("$services.localization.render('yes')");q.insert(p);p.on("click",t);p=new Element("button",{"class":"btn btn-primary",id:"cancel-save-csrf"});p.insert("$services.localization.render('no')");q.insert(p);p.on("click",function(){s.closeDialog()});r.insert(q);return r};this.enableEditors();this.displayErrorModal(n)}else{this.on401(l)}document.fire("xwiki:document:saveFailed",{response:l})},on409:function(o,m){var u=this;this.progressBox.hide();this.savingBox.hide();this.savedBox.hide();this.failedBox.hide();var p=function(){window.location.reload()};var r=function(){require(["jquery"],function(v){v("#previewDiffModal").modal("hide");u.form.insert(new Element("input",{type:"hidden",name:"forceSave",id:"forceSave",value:"1"}));if(m){v("input[name=action_saveandcontinue]").click()}else{v("input[name=action_save]").click()}})};var l=function(){require(["jquery"],function(v){if(v("#actionReloadRadio").is(":checked")){p()}if(v("#actionForceSaveRadio").is(":checked")){r()}})};var q=function(){require(["jquery"],function(y){var x=y("#headingReloadEditor").parent();var z=y("#headingForceSave").parent();var w=y("#actionReloadRadio");var v=y("#actionForceSaveRadio");x.toggleClass("panel-primary",w.is(":checked"));x.toggleClass("panel-danger",v.is(":checked"));z.toggleClass("panel-primary",v.is(":checked"));z.toggleClass("panel-default",w.is(":checked"))})};var t=function(v){require(["jquery"],function(w){w(v.responseText).appendTo("body");w("#previewDiffModal").modal("show");w("#previewDiffModal").on("hidden.bs.modal",function(x){w("#previewDiffModal").remove();w("div.modal-backdrop").remove()});w("input[name=warningConflictAction]").on("click",q);w("#submitDiffButton").on("click",l)})};this.enableEditors();var n=new Hash(this.form.serialize({hash:true,submit:"preview"}));var j=o.responseJSON;var k="diff=1&version="+j.latestVersion;var s=new e.Document().getURL("preview",k);new Ajax.Request(s,{method:"post",parameters:n.toQueryString(),onSuccess:t,onFailure:this.onFailure.bind(this)});document.fire("xwiki:document:saveFailed",{response:o})},onFailure:function(j){this.enableEditors();this.savingBox.replace(this.failedBox);this.progressBox.replace(this.failedBox);if(j.statusText==""||j.status==12031){$("ajaxRequestFailureReason").update("Server not responding")}else{if(j.getHeader("Content-Type").match(/^\s*text\/plain/)){$("ajaxRequestFailureReason").update(j.responseText)}else{$("ajaxRequestFailureReason").update(j.statusText)}}document.fire("xwiki:document:saveFailed",{response:j})},startStatusReport:function(j){updateStatus(0)},getStatus:function(l,k,j){new Ajax.Request(l,{method:"get",parameters:{media:"json"},onSuccess:function(n){var m=n.responseJSON.progress.offset;this.updateStatus(m);if(m<1){setTimeout(this.getStatus.bind(this,l,k),1000)}else{this.progressBox.replace(this.savedBox);this.maybeRedirect(k)}}.bindAsEventListener(this),on1223:this.on1223.bindAsEventListener(this),on0:this.on0.bindAsEventListener(this),onFailure:this.onFailure.bindAsEventListener(this)})},updateStatus:function(j){var l=""+(j*100);var k=l.indexOf(".");if(k>-1){var l=l.substring(0,k+2)}var m=new e.widgets.Notification(this.progressMessageTemplate.replace("__PROGRESS__",l),"inprogress");this.progressBox.replace(m);this.progressBox=m},maybeRedirect:function(l){var j="";if(!l){j=e.currentDocument.getURL();var k=this.form.select('input[name="xredirect"]')[0];if(k&&k.value){j=k.value}}else{if($("body").hasClassName("previewbody")){j=e.currentDocument.getURL("edit");if(this.form.xcontinue&&this.form.xcontinue.value){j=this.form.xcontinue.value}}else{return}}if(j){window.location=j}}});function i(){require(["xwiki-meta"],function(j){c=j.documentReference;d=j.isNew;f=j.version;j.refreshVersion(function(){d=true;a=true})});if($("content")){$("content").value=$("content").defaultValue}new h.EditActions();new h.AjaxSaveAndContinue();return true}(e.domIsLoaded&&i())||document.observe("xwiki:dom:loaded",i);return e}(XWiki||{}));require(["jquery"],function(b){var c=b(".sticky-buttons");if(c.length==0){return}var a=b("<div></div>");a.height(0);a.insertBefore(c);b(window).on("scroll resize load click xwiki:dom:refresh",function(){var f=b(".fullScreenWrapper").length>0;var e=c.is(":visible");a.height(c.height());var d=a.offset().top+a.height();if(e&&!f&&b(window).height()+b(window).scrollTop()<d){c.addClass("sticky-buttons-fixed");c.innerWidth(c.parent().width())}else{c.removeClass("sticky-buttons-fixed");c.innerWidth("");a.height(0)}})});